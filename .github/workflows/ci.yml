name: CI

on:
  pull_request:
    branches:
      - dev
      - release
  push:
    branches:
      - dev

jobs:
  ci:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend/api

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      - name: Detect backend changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=origin/${{ github.base_ref }}
            git fetch origin ${{ github.base_ref }}
          else
            BASE=HEAD~1
          fi

          if git diff --name-only $BASE...HEAD | grep '^backend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build & Test
        if: steps.changes.outputs.changed == 'true'
        run: ./gradlew build

      - name: Skip backend CI
        if: steps.changes.outputs.changed == 'false'
        run: echo "No backend changes detected. Skipping backend CI."