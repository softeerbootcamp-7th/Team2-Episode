name: CI

on:
    pull_request:
        branches: [dev, release]
    push:
        branches: [dev]

jobs:
    detect-changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            api: ${{ steps.filter.outputs.api }}
            runner: ${{ steps.filter.outputs.runner }}
            frontend: ${{ steps.filter.outputs.frontend }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v2
              id: filter
              with:
                  filters: |
                      api:
                        - 'backend/api/**'
                      runner:
                        - 'backend/yjs-runner/**'
                      frontend:
                        - 'frontend/**'

    lint:
        name: Check Style
        needs: detect-changes
        if: needs.detect-changes.outputs.api == 'true'
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend/api
        steps:
            - uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17
                  cache: gradle
            - run: chmod +x ./gradlew

            - name: Run Checkstyle
              run: ./gradlew checkstyleMain checkstyleTest --no-daemon

    build_api:
        name: Build & Test (API)
        needs: detect-changes
        if: needs.detect-changes.outputs.api == 'true'
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend/api
        steps:
            - uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17
                  cache: gradle
            - run: chmod +x ./gradlew

            - name: Build
              run: ./gradlew build -x checkstyleMain -x checkstyleTest --no-daemon

    build_runner:
        name: Build & Test (Yjs Runner)
        needs: detect-changes
        if: needs.detect-changes.outputs.runner == 'true'
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: backend/yjs-runner
        steps:
            - uses: actions/checkout@v4

            - name: Set up Node
              uses: actions/setup-node@v4
              with:
                  node-version: 24
                  cache: npm
                  cache-dependency-path: backend/yjs-runner/package-lock.json

            - name: Install
              run: npm ci

            - name: Build
              run: npm run build --if-present

            - name: Test
              run: npm test --if-present

    build_frontend:
        name: Build Frontend
        needs: detect-changes
        if: needs.detect-changes.outputs.frontend == 'true'
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: pnpm
                  cache-dependency-path: frontend/pnpm-lock.yaml

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint
              run: pnpm run lint

            - name: Build
              run: pnpm run build
